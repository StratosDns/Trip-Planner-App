<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trip Planner</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <header class="topbar">
      <a class="logo-fab" href="{{ url_for('feed') }}" aria-label="Go to feed">âœˆ</a>

      <nav class="top-icons">
        {% if session.get('user_id') %}
          <a class="pill-link" href="{{ url_for('my_trips') }}">My Trips</a>

          <div class="notif-wrap">
            <button class="icon-btn bell" id="notifToggle" aria-label="Notifications" type="button">
              ðŸ””
              {% if pending_notification_count > 0 %}
                <span class="notif-dot" aria-hidden="true"></span>
              {% endif %}
            </button>

            <div class="notif-popover" id="notifPopover" hidden>
              <h4>Notifications</h4>
              {% if header_notifications %}
                <ul>
                  {% for notification in header_notifications %}
                    <li class="notif-item">
                      <div>
                        <strong>{{ notification['trip_title'] }}</strong> â€” {{ notification['message'] }}
                        <span class="muted">[{{ notification['status'] }}]</span>
                      </div>
                      {% if notification['status'] == 'pending' %}
                        <div class="actions-inline">
                          <form method="post" action="{{ url_for('respond_notification', notification_id=notification['id'], action='accept') }}">
                            <button type="submit">Accept</button>
                          </form>
                          <form method="post" action="{{ url_for('respond_notification', notification_id=notification['id'], action='deny') }}">
                            <button type="submit" class="button secondary">Deny</button>
                          </form>
                        </div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="muted">No notifications yet.</p>
              {% endif %}
            </div>
          </div>

          <a class="icon-btn" href="{{ url_for('profile') }}" aria-label="Profile">ðŸ‘¤</a>
          <a class="pill-link" href="{{ url_for('logout') }}">Logout</a>
        {% else %}
          <a class="pill-link" href="{{ url_for('login') }}">Login</a>
          <a class="pill-link" href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </nav>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flash-list">
          {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <main>
      {% block content %}{% endblock %}
    </main>

    {% if session.get('user_id') %}
      <script>
        (function () {
          const toggle = document.getElementById('notifToggle');
          const popover = document.getElementById('notifPopover');
          if (!toggle || !popover) return;

          toggle.addEventListener('click', () => {
            popover.hidden = !popover.hidden;
          });

          document.addEventListener('click', (event) => {
            if (popover.hidden) return;
            const inside = popover.contains(event.target) || toggle.contains(event.target);
            if (!inside) popover.hidden = true;
          });
        })();
      </script>
    {% endif %}
    <script>
      window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
  </body>
</html>
